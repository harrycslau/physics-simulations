<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Snell's Law Refraction Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none;
        }
        .slider-thumb::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .slider-track::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E5E7EB;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen relative">

    <div class="absolute top-4 right-4 flex gap-2 z-30">
        <button type="button" data-lang-switch="en-US" class="px-3 py-1 text-xs font-semibold border border-indigo-200 rounded-full bg-white/80 text-indigo-700 hover:bg-white hover:text-indigo-900 transition" data-i18n="languageButtonEnglish">EN</button>
        <button type="button" data-lang-switch="zh-HK" class="px-3 py-1 text-xs font-semibold border border-indigo-200 rounded-full bg-white/80 text-indigo-700 hover:bg-white hover:text-indigo-900 transition" data-i18n="languageButtonChinese">繁</button>
    </div>

    <header class="bg-indigo-600 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-rainbow text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold" data-i18n="headerTitle">Snell's Law Virtual Lab</h1>
                    <p class="text-xs text-indigo-200" data-i18n="headerSubtitle">Measure refractive index using refraction angles (Snell's Law)</p>
                </div>
            </div>
            <button id="resetButton" class="bg-indigo-500 hover:bg-indigo-400 px-3 py-1 rounded text-sm transition flex items-center gap-2">
                <i class="fa-solid fa-rotate-right"></i> <span data-i18n="resetButton">Reset Experiment</span>
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-md p-1 overflow-hidden relative border border-gray-200">
                <div class="absolute top-4 left-4 bg-white/90 backdrop-blur p-2 rounded shadow text-sm z-10">
                    <div class="flex items-center gap-2 text-red-600 font-bold">
                        <span class="w-3 h-3 rounded-full bg-red-500 inline-block"></span>
                        <span data-i18n="incidentLabel">Angle of incidence (i):</span> <span id="val-i">30.0</span>°
                    </div>
                    <div class="flex items-center gap-2 text-blue-600 font-bold mt-1">
                        <span class="w-3 h-3 rounded-full bg-blue-500 inline-block"></span>
                        <span data-i18n="refractionLabel">Angle of refraction (r):</span> <span id="val-r">0.0</span>°
                    </div>
                </div>
                <canvas id="simCanvas" class="w-full h-auto bg-gray-50 block cursor-pointer" height="400" width="600"></canvas>
                <p class="text-center text-xs text-gray-400 py-1" data-i18n="canvasHint">Tap or drag on the canvas to adjust the angle directly.</p>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders text-indigo-500"></i> <span data-i18n="controlsHeading">Parameter Controls</span>
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="font-medium text-gray-700" data-i18n="incidentSliderLabel">Angle of incidence (i)</label>
                            <span class="text-indigo-600 font-mono font-bold" id="display-angle">30°</span>
                        </div>
                        <input type="range" id="angleSlider" min="0" max="85" step="0.5" value="30" class="slider-thumb slider-track w-full appearance-none bg-transparent">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span data-i18n="incidentSliderMin">0° (Normal)</span>
                            <span>85°</span>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="font-medium text-gray-700" data-i18n="riSliderLabel">Refractive index of medium (n)</label>
                            <span class="text-indigo-600 font-mono font-bold" id="display-ri">1.50</span>
                        </div>
                        <input type="range" id="nSlider" min="1.00" max="2.50" step="0.01" value="1.50" class="slider-thumb slider-track w-full appearance-none bg-transparent">
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span data-i18n="riHintAir">1.0 (Air)</span>
                            <span data-i18n="riHintGlass">1.5 (Glass)</span>
                            <span data-i18n="riHintDiamond">2.4 (Diamond)</span>
                        </div>
                    </div>

                    <div class="pt-2">
                        <button id="recordButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition flex items-center justify-center gap-2 active:scale-95">
                            <i class="fa-solid fa-plus-circle"></i> <span data-i18n="recordButton">Record Data Point</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-md p-4 border border-gray-200">
                <h2 class="text-lg font-semibold mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-chart-line text-indigo-500"></i> <span data-i18n="graphHeading">sin(i) vs sin(r) Relationship</span>
                </h2>
                <div class="relative w-full h-64 bg-white border border-gray-100 rounded">
                    <canvas id="graphCanvas" class="w-full h-full block"></canvas>
                </div>
                <div class="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div class="text-center sm:text-left">
                        <p class="text-sm text-gray-600" data-i18n="slopeLabel">Best-fit slope (m)</p>
                        <p class="text-2xl font-bold text-indigo-700" id="slopeValue">--</p>
                    </div>
                    <div class="text-center sm:text-right">
                        <p class="text-sm text-gray-600" data-i18n="calcNLabel">Measured refractive index (n)</p>
                        <p class="text-2xl font-bold text-green-600" id="calcN">--</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center" data-i18n="graphExplanation">
                    Theory: n₁ sin(i) = n₂ sin(r). Taking n₁ = 1 (air), the slope of sin(i) vs sin(r) approximates n.
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200 overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-table text-indigo-500"></i> <span data-i18n="tableHeading">Recorded Data</span>
                    </h2>
                    <button id="clearButton" class="text-sm text-red-500 hover:text-red-700 font-medium flex items-center gap-2">
                        <i class="fa-solid fa-trash"></i> <span data-i18n="clearButton">Clear Data</span>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-4 py-3 rounded-tl-lg">#</th>
                                <th scope="col" class="px-4 py-3" data-i18n="tableColIncident">i (°)</th>
                                <th scope="col" class="px-4 py-3" data-i18n="tableColRefraction">r (°)</th>
                                <th scope="col" class="px-4 py-3 bg-blue-50 text-blue-700" data-i18n="tableColSinI">sin(i) (y)</th>
                                <th scope="col" class="px-4 py-3 bg-green-50 text-green-700 rounded-tr-lg" data-i18n="tableColSinR">sin(r) (x)</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr class="border-b hover:bg-gray-50">
                                <td colspan="5" class="px-4 py-4 text-center text-gray-400 italic" data-i18n="tableEmpty">
                                    No data yet. Adjust the angles and tap "Record Data Point".
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center p-4 text-gray-400 text-xs">
        &copy; 2023 <span data-i18n="footerText">Physics Lab Teaching Tools</span>
    </footer>

    <script>
        const translations = {
            "en-US": {
                title: "Snell's Law Refraction Lab",
                languageButtonEnglish: "EN",
                languageButtonChinese: "繁",
                headerTitle: "Snell's Law Virtual Lab",
                headerSubtitle: "Measure refractive index using refraction angles (Snell's Law)",
                resetButton: "Reset Experiment",
                incidentLabel: "Angle of incidence (i):",
                refractionLabel: "Angle of refraction (r):",
                canvasHint: "Tap or drag on the canvas to adjust the angle directly.",
                controlsHeading: "Parameter Controls",
                incidentSliderLabel: "Angle of incidence (i)",
                incidentSliderMin: "0° (Normal)",
                riSliderLabel: "Refractive index of medium (n)",
                riHintAir: "1.0 (Air)",
                riHintGlass: "1.5 (Glass)",
                riHintDiamond: "2.4 (Diamond)",
                recordButton: "Record Data Point",
                graphHeading: "sin(i) vs sin(r) Relationship",
                slopeLabel: "Best-fit slope (m)",
                calcNLabel: "Measured refractive index (n)",
                graphExplanation: "Theory: n₁ sin(i) = n₂ sin(r). Taking n₁ = 1 (air), the slope of sin(i) vs sin(r) approximates n.",
                tableHeading: "Recorded Data",
                clearButton: "Clear Data",
                tableColIncident: "i (°)",
                tableColRefraction: "r (°)",
                tableColSinI: "sin(i) (y)",
                tableColSinR: "sin(r) (x)",
                tableEmpty: "No data yet. Adjust the angles and tap \"Record Data Point\".",
                footerText: "Physics Lab Teaching Tools"
            },
            "zh-HK": {
                title: "斯涅耳定律 - 折射率實驗",
                languageButtonEnglish: "EN",
                languageButtonChinese: "繁",
                headerTitle: "斯涅耳定律虛擬實驗室",
                headerSubtitle: "測定透明介質的折射率（Snell 定律）",
                resetButton: "重置實驗",
                incidentLabel: "入射角 (i)：",
                refractionLabel: "折射角 (r)：",
                canvasHint: "點擊或拖曳畫布可直接改變角度。",
                controlsHeading: "實驗參數控制",
                incidentSliderLabel: "入射角 (i)",
                incidentSliderMin: "0°（法線）",
                riSliderLabel: "透明介質折射率 (n)",
                riHintAir: "1.0（空氣）",
                riHintGlass: "1.5（玻璃）",
                riHintDiamond: "2.4（鑽石）",
                recordButton: "記錄數據點",
                graphHeading: "sin(i) 對 sin(r) 關係圖",
                slopeLabel: "最佳擬合斜率 (m)",
                calcNLabel: "計算折射率 (n)",
                graphExplanation: "理論：n₁ sin(i) = n₂ sin(r)。當 n₁ = 1（空氣）時，sin(i) 與 sin(r) 的斜率近似於 n。",
                tableHeading: "實驗數據表",
                clearButton: "清除數據",
                tableColIncident: "i (°)",
                tableColRefraction: "r (°)",
                tableColSinI: "sin(i) (y)",
                tableColSinR: "sin(r) (x)",
                tableEmpty: "尚未記錄數據。調整角度並點擊「記錄數據點」。",
                footerText: "物理實驗室教學工具"
            }
        };

        let currentLang = "en-US";

        function getTranslation(key) {
            const dict = translations[currentLang] || translations["en-US"];
            return dict[key] ?? "";
        }

        function applyTranslations() {
            const dict = translations[currentLang] || translations["en-US"];
            document.documentElement.lang = currentLang;
            document.title = dict.title || document.title;
            document.querySelectorAll("[data-i18n]").forEach((el) => {
                const key = el.dataset.i18n;
                if (!key) return;
                const text = dict[key];
                if (typeof text !== "undefined") {
                    el.textContent = text;
                }
            });
            updateLangButtons();
            updateTable();
            updateSimulation();
        }

        function updateLangButtons() {
            document.querySelectorAll("[data-lang-switch]").forEach((btn) => {
                const isActive = btn.dataset.langSwitch === currentLang;
                btn.classList.toggle("text-indigo-900", isActive);
                btn.classList.toggle("text-indigo-700", !isActive);
                btn.classList.toggle("shadow-lg", isActive);
                btn.classList.toggle("bg-white", isActive);
                btn.classList.toggle("bg-white/80", !isActive);
                btn.classList.toggle("ring-1", isActive);
                btn.classList.toggle("ring-indigo-300", isActive);
            });
        }

        function setLanguage(lang, skipUrlUpdate = false) {
            if (!translations[lang]) lang = "en-US";
            currentLang = lang;
            applyTranslations();
            if (!skipUrlUpdate) {
                const url = new URL(window.location);
                url.searchParams.set("lang", lang);
                window.history.pushState({}, "", url);
            }
        }

        function setupLanguageSwitcher() {
            document.querySelectorAll("[data-lang-switch]").forEach((btn) => {
                btn.addEventListener("click", () => setLanguage(btn.dataset.langSwitch));
            });
        }

        function initLanguage() {
            setupLanguageSwitcher();
            const params = new URLSearchParams(window.location.search);
            const langParam = params.get("lang");
            const initialLang = translations[langParam] ? langParam : "en-US";
            setLanguage(initialLang, true);
        }

        const degToRad = (deg) => deg * (Math.PI / 180);
        const radToDeg = (rad) => rad * (180 / Math.PI);

        let state = {
            angleIncident: 30,
            refractiveIndex: 1.5,
            dataPoints: []
        };

        let isDragging = false;

        const simCanvas = document.getElementById('simCanvas');
        const simCtx = simCanvas.getContext('2d');
        const graphCanvas = document.getElementById('graphCanvas');
        const graphCtx = graphCanvas.getContext('2d');
        const angleSlider = document.getElementById('angleSlider');
        const nSlider = document.getElementById('nSlider');
        const displayAngle = document.getElementById('display-angle');
        const displayRI = document.getElementById('display-ri');
        const valI = document.getElementById('val-i');
        const valR = document.getElementById('val-r');
        const slopeValue = document.getElementById('slopeValue');
        const calcN = document.getElementById('calcN');
        const dataTableBody = document.getElementById('dataTableBody');
        const recordButton = document.getElementById('recordButton');
        const clearButton = document.getElementById('clearButton');
        const resetButton = document.getElementById('resetButton');

        function init() {
            resizeCanvases();
            window.addEventListener('resize', resizeCanvases);
            angleSlider.addEventListener('input', (e) => {
                state.angleIncident = parseFloat(e.target.value);
                updateSimulation();
            });
            nSlider.addEventListener('input', (e) => {
                state.refractiveIndex = parseFloat(e.target.value);
                updateSimulation();
            });
            simCanvas.addEventListener('mousedown', startDrag);
            simCanvas.addEventListener('touchstart', startDrag, {passive: false});
            window.addEventListener('mousemove', doDrag);
            window.addEventListener('touchmove', doDrag, {passive: false});
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);
            recordButton.addEventListener('click', recordData);
            clearButton.addEventListener('click', clearData);
            resetButton.addEventListener('click', resetExperiment);
            updateSimulation();
            updateGraph();
        }

        function resizeCanvases() {
            const dpr = window.devicePixelRatio || 1;
            const simRect = simCanvas.parentElement.getBoundingClientRect();
            simCanvas.width = simRect.width * dpr;
            simCanvas.height = 400 * dpr;
            simCtx.setTransform(1, 0, 0, 1, 0, 0);
            simCtx.scale(dpr, dpr);
            simCanvas.style.width = `${simRect.width}px`;
            simCanvas.style.height = `400px`;
            const graphRect = graphCanvas.parentElement.getBoundingClientRect();
            graphCanvas.width = graphRect.width * dpr;
            graphCanvas.height = 256 * dpr;
            graphCtx.setTransform(1, 0, 0, 1, 0, 0);
            graphCtx.scale(dpr, dpr);
            graphCanvas.style.width = `${graphRect.width}px`;
            graphCanvas.style.height = `256px`;
            updateSimulation();
            updateGraph();
        }

        function updateSimulation() {
            const dpr = window.devicePixelRatio || 1;
            const width = simCanvas.width / dpr;
            const height = simCanvas.height / dpr;
            const centerX = width / 2;
            const centerY = height / 2 + 50;
            const radius = 140;
            simCtx.clearRect(0, 0, width, height);
            const n1 = 1.0;
            const n2 = state.refractiveIndex;
            const thetaI = degToRad(state.angleIncident);
            const sinR = Math.min((n1 / n2) * Math.sin(thetaI), 1);
            const thetaR = Math.asin(sinR);
            const angleR_deg = radToDeg(thetaR);
            displayAngle.textContent = state.angleIncident.toFixed(1) + "°";
            displayRI.textContent = state.refractiveIndex.toFixed(2);
            valI.textContent = state.angleIncident.toFixed(1);
            valR.textContent = angleR_deg.toFixed(1);

            simCtx.beginPath();
            simCtx.arc(centerX, centerY, radius, 0, Math.PI);
            simCtx.closePath();
            simCtx.fillStyle = 'rgba(199, 210, 254, 0.5)';
            simCtx.fill();
            simCtx.strokeStyle = '#4F46E5';
            simCtx.lineWidth = 2;
            simCtx.stroke();

            simCtx.beginPath();
            simCtx.setLineDash([5, 5]);
            simCtx.moveTo(centerX, centerY - radius - 20);
            simCtx.lineTo(centerX, centerY + radius + 20);
            simCtx.strokeStyle = '#6B7280';
            simCtx.lineWidth = 1;
            simCtx.stroke();
            simCtx.setLineDash([]);

            const rayLength = radius + 40;
            const incX = centerX - rayLength * Math.sin(thetaI);
            const incY = centerY - rayLength * Math.cos(thetaI);
            simCtx.beginPath();
            simCtx.moveTo(incX, incY);
            simCtx.lineTo(centerX, centerY);
            simCtx.strokeStyle = '#EF4444';
            simCtx.lineWidth = 3;
            simCtx.stroke();
            drawArrow(simCtx, incX, incY, centerX, centerY, '#EF4444');

            const refX = centerX + radius * Math.sin(thetaR);
            const refY = centerY + radius * Math.cos(thetaR);
            simCtx.beginPath();
            simCtx.moveTo(centerX, centerY);
            simCtx.lineTo(refX, refY);
            simCtx.strokeStyle = '#2563EB';
            simCtx.lineWidth = 3;
            simCtx.stroke();
            drawArrow(simCtx, centerX, centerY, refX, refY, '#2563EB');

            simCtx.font = "bold 14px sans-serif";
            simCtx.fillStyle = "#EF4444";
            simCtx.fillText("i", centerX - 20 * Math.sin(thetaI/2), centerY - 30);
            simCtx.fillStyle = "#2563EB";
            simCtx.fillText("r", centerX + 20 * Math.sin(thetaR/2), centerY + 40);
            simCtx.fillStyle = "#374151";
            simCtx.fillText(`n = ${state.refractiveIndex.toFixed(2)}`, centerX + radius - 60, centerY + 30);
        }

        function drawArrow(ctx, fromX, fromY, toX, toY, color) {
            const headlen = 10;
            const dx = toX - fromX;
            const dy = toY - fromY;
            const angle = Math.atan2(dy, dx);
            const midX = (fromX + toX) / 2;
            const midY = (fromY + toY) / 2;
            ctx.beginPath();
            ctx.moveTo(midX, midY);
            ctx.lineTo(midX - headlen * Math.cos(angle - Math.PI / 6), midY - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(midX, midY);
            ctx.lineTo(midX - headlen * Math.cos(angle + Math.PI / 6), midY - headlen * Math.sin(angle + Math.PI / 6));
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function startDrag(e) {
            const rect = simCanvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            if (y < 400/2 + 50) {
                isDragging = true;
                updateAngleFromMouse(x, y);
            }
        }

        function doDrag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const rect = simCanvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            updateAngleFromMouse(x, y);
        }

        function endDrag() {
            isDragging = false;
        }

        function updateAngleFromMouse(x, y) {
            const width = simCanvas.getBoundingClientRect().width;
            const centerX = width / 2;
            const centerY = 400 / 2 + 50;
            const dx = centerX - x;
            const dy = centerY - y;
            if (dy < 0) return;
            let angleRad = Math.atan2(dx, dy);
            let angleDeg = radToDeg(angleRad);
            angleDeg = Math.max(0, Math.min(85, angleDeg));
            state.angleIncident = angleDeg;
            angleSlider.value = angleDeg;
            updateSimulation();
        }

        function recordData() {
            const i = state.angleIncident;
            const sinI = Math.sin(degToRad(i));
            const sinR = Math.min((1 / state.refractiveIndex) * sinI, 1);
            const r = radToDeg(Math.asin(sinR));
            const newData = { id: Date.now(), i, r, sinI, sinR };
            state.dataPoints.push(newData);
            state.dataPoints.sort((a, b) => a.i - b.i);
            updateTable();
            updateGraph();
        }

        function clearData() {
            state.dataPoints = [];
            slopeValue.textContent = "--";
            calcN.textContent = "--";
            updateTable();
            updateGraph();
        }

        function updateTable() {
            dataTableBody.innerHTML = "";
            if (state.dataPoints.length === 0) {
                dataTableBody.innerHTML = `
                    <tr class="border-b hover:bg-gray-50">
                        <td colspan="5" class="px-4 py-4 text-center text-gray-400 italic" data-i18n="tableEmpty">
                            ${getTranslation('tableEmpty')}
                        </td>
                    </tr>`;
                return;
            }
            state.dataPoints.forEach((pt, index) => {
                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50 transition";
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-4 py-3">${pt.i.toFixed(1)}°</td>
                    <td class="px-4 py-3">${pt.r.toFixed(1)}°</td>
                    <td class="px-4 py-3 bg-blue-50 text-blue-700 font-mono">${pt.sinI.toFixed(3)}</td>
                    <td class="px-4 py-3 bg-green-50 text-green-700 font-mono">${pt.sinR.toFixed(3)}</td>
                `;
                dataTableBody.appendChild(row);
            });
        }

        function resetExperiment() {
            clearData();
            state.angleIncident = 30;
            state.refractiveIndex = 1.5;
            angleSlider.value = 30;
            nSlider.value = 1.5;
            updateSimulation();
        }

        function updateGraph() {
            const dpr = window.devicePixelRatio || 1;
            const width = graphCanvas.width / dpr;
            const height = graphCanvas.height / dpr;
            graphCtx.clearRect(0, 0, width, height);
            const padLeft = 50;
            const padBottom = 40;
            const padRight = 50; 
            const padTop = 35;
            const gW = width - padLeft - padRight;
            const gH = height - padTop - padBottom;
            graphCtx.beginPath();
            graphCtx.strokeStyle = '#9CA3AF';
            graphCtx.lineWidth = 2;
            graphCtx.moveTo(padLeft, height - padBottom);
            graphCtx.lineTo(padLeft, padTop);
            graphCtx.moveTo(padLeft, height - padBottom);
            graphCtx.lineTo(width - padRight, height - padBottom);
            graphCtx.stroke();
            graphCtx.beginPath();
            const headLen = 8;
            graphCtx.moveTo(padLeft, padTop);
            graphCtx.lineTo(padLeft - 5, padTop + headLen);
            graphCtx.moveTo(padLeft, padTop);
            graphCtx.lineTo(padLeft + 5, padTop + headLen);
            const xEnd = width - padRight;
            const yEnd = height - padBottom;
            graphCtx.moveTo(xEnd, yEnd);
            graphCtx.lineTo(xEnd - headLen, yEnd - 5);
            graphCtx.moveTo(xEnd, yEnd);
            graphCtx.lineTo(xEnd - headLen, yEnd + 5);
            graphCtx.stroke();
            graphCtx.fillStyle = '#374151';
            graphCtx.font = "bold 14px sans-serif";
            graphCtx.textAlign = "left";
            graphCtx.fillText("sin(r)", xEnd + 8, yEnd + 4);
            graphCtx.textAlign = "center";
            graphCtx.fillText("sin(i)", padLeft, padTop - 10);
            const maxX = 0.8;
            const maxY = 1.0;
            const d2pX = (val) => padLeft + (val / maxX) * gW;
            const d2pY = (val) => height - padBottom - (val / maxY) * gH;
            graphCtx.strokeStyle = '#E5E7EB';
            graphCtx.lineWidth = 1;
            graphCtx.beginPath();
            for(let i=0.2; i<=1.0; i+=0.2) {
                const y = d2pY(i);
                graphCtx.moveTo(padLeft, y);
                graphCtx.lineTo(width - padRight, y);
                const x = d2pX(i * maxX);
                graphCtx.moveTo(x, height - padBottom);
            }
            graphCtx.stroke();

            if (state.dataPoints.length > 0) {
                state.dataPoints.forEach(pt => {
                    const px = d2pX(pt.sinR);
                    const py = d2pY(pt.sinI);
                    graphCtx.beginPath();
                    graphCtx.arc(px, py, 4, 0, Math.PI * 2);
                    graphCtx.fillStyle = '#DC2626';
                    graphCtx.fill();
                });
                let sumXY = 0;
                let sumXX = 0;
                state.dataPoints.forEach(pt => {
                    sumXY += pt.sinR * pt.sinI;
                    sumXX += pt.sinR * pt.sinR;
                });
                if (sumXX > 0) {
                    const slope = sumXY / sumXX;
                    graphCtx.beginPath();
                    graphCtx.moveTo(d2pX(0), d2pY(0));
                    let endX = maxX;
                    let endY = slope * endX;
                    if (endY > maxY) {
                        endY = maxY;
                        endX = endY / slope;
                    }
                    graphCtx.lineTo(d2pX(endX), d2pY(endY));
                    graphCtx.strokeStyle = '#10B981';
                    graphCtx.lineWidth = 2;
                    graphCtx.stroke();
                    slopeValue.textContent = slope.toFixed(3);
                    calcN.textContent = slope.toFixed(3);
                }
            }
        }

        initLanguage();
        init();
    </script>
</body>
</html>
