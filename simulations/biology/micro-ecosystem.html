<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">Micro-Ecosystem Gas Cycle Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .sky-gradient {
            transition: background 1s ease;
        }
        .day-sky {
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA);
        }
        .night-sky {
            background: linear-gradient(to bottom, #0B1026, #2B32B2);
            color: white;
        }
        .bubble {
            position: absolute;
            bottom: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: floatUp 4s infinite linear;
            opacity: 0;
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 0.8; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 relative">

    <header class="bg-teal-700 text-white p-4 shadow-md relative">
        <div class="absolute top-4 right-4 flex gap-2 z-20">
            <button type="button" data-lang-switch="en-US" class="px-3 py-1 text-xs font-semibold border border-white/60 rounded-full bg-white/80 text-teal-800 hover:bg-white hover:text-teal-900 transition" data-i18n="languageButtonEnglish">EN</button>
            <button type="button" data-lang-switch="zh-HK" class="px-3 py-1 text-xs font-semibold border border-white/60 rounded-full bg-white/80 text-teal-800 hover:bg-white hover:text-teal-900 transition" data-i18n="languageButtonChinese">ç¹</button>
        </div>
        <div class="container mx-auto flex justify-between items-center pr-32">
            <h1 class="text-2xl font-bold flex items-center gap-2"><i class="fas fa-leaf"></i><span data-i18n="headerTitle">Micro-Ecosystem Gas Cycle Simulator</span></h1>
            <span class="text-sm bg-teal-800 px-3 py-1 rounded-full" data-i18n="headerTag">Science Experiment Simulation</span>
        </div>
    </header>

    <main class="container mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 space-y-6">
            <div id="ecosystem-container" class="bg-white rounded-xl shadow-lg overflow-hidden border-4 border-gray-300 relative h-80 transition-colors duration-1000 day-sky">
                <div class="absolute top-4 right-4 text-5xl transition-all duration-1000" id="celestial-body">â˜€ï¸</div>
                <div class="absolute top-4 left-4 bg-black/30 text-white px-3 py-1 rounded backdrop-blur-sm">
                    <div class="text-xs uppercase font-bold" data-i18n="timeLabel">Time</div>
                    <div class="text-xl font-mono" id="clock-display">06:00</div>
                </div>
                <div class="absolute bottom-0 w-full h-24 bg-amber-800 border-t-4 border-green-800 flex justify-around items-end px-4 pb-2">
                    <div id="plants-container" class="flex space-x-2 text-4xl text-green-600">
                        <i class="fas fa-tree"></i><i class="fas fa-seedling"></i>
                    </div>
                    <div id="animals-container" class="flex space-x-2 text-3xl text-gray-700">
                        <i class="fas fa-frog"></i>
                    </div>
                </div>
                <div id="bubbles-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
                <div class="absolute bottom-28 left-1/2 transform -translate-x-1/2 bg-white/80 px-4 py-2 rounded-lg shadow text-center w-3/4">
                    <p id="status-text" class="font-bold text-teal-700">Photosynthesis in progress</p>
                    <p class="text-xs text-gray-600" data-i18n="netGasLabel">Net gas change</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-lg font-bold mb-4 border-b pb-2" data-i18n="controlHeading">Experiment Parameters</h2>
                <div class="space-y-4">
                    <div class="flex space-x-2">
                        <button id="btn-play" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded transition flex items-center justify-center gap-2" onclick="toggleSimulation()">
                            <i class="fas fa-play"></i><span data-i18n="startButton">Start</span>
                        </button>
                        <button class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded transition flex items-center justify-center gap-2" onclick="resetSimulation()">
                            <i class="fas fa-redo"></i><span data-i18n="resetButton">Reset</span>
                        </button>
                    </div>

                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium mb-1" data-i18n="plantLabel">Number of plants (producers)</label>
                        <input type="range" id="plant-slider" min="1" max="10" value="5" class="w-full accent-green-600" oninput="updateSettings()">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span data-i18n="fewLabel">Few</span>
                            <span id="plant-count">5</span>
                            <span data-i18n="manyLabel">Many</span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="animalLabel">Number of animals (consumers)</label>
                        <input type="range" id="animal-slider" min="0" max="5" value="2" class="w-full accent-orange-600" oninput="updateSettings()">
                        <div class="flex justify-between text-xs text-gray-500">
                            <span data-i18n="noneLabel">None</span>
                            <span id="animal-count">2</span>
                            <span data-i18n="manyLabel">Many</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1" data-i18n="speedLabel">Simulation speed</label>
                        <select id="speed-select" class="w-full border rounded p-2 bg-gray-50" onchange="updateSettings()">
                            <option value="200" data-i18n="speedSlow">Slow (detailed view)</option>
                            <option value="100" selected data-i18n="speedNormal">Normal</option>
                            <option value="20" data-i18n="speedFast">Fast (trend focus)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-lg h-96 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-700" data-i18n="chartHeading">Gas concentration trends</h2>
                    <div class="flex space-x-4 text-sm">
                        <div class="flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span><span data-i18n="legendO2">Oxygen (Oâ‚‚)</span></div>
                        <div class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span><span data-i18n="legendCO2">Carbon dioxide (COâ‚‚)</span></div>
                    </div>
                </div>
                <div class="flex-1 relative w-full">
                    <canvas id="gasChart"></canvas>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center">
                    <h3 class="text-gray-500 text-sm uppercase" data-i18n="currentO2Label">Current oxygen concentration</h3>
                    <p class="text-3xl font-bold text-blue-600" id="o2-display">21.000%</p>
                    <p class="text-xs text-gray-400 mt-1" data-i18n="initialO2">Initial value: 21.0%</p>
                </div>
                <div class="bg-red-50 p-4 rounded-xl border border-red-200 text-center">
                    <h3 class="text-gray-500 text-sm uppercase" data-i18n="currentCO2Label">Current carbon dioxide concentration</h3>
                    <p class="text-3xl font-bold text-red-600" id="co2-display">0.0400%</p>
                    <p class="text-xs text-gray-400 mt-1" data-i18n="initialCO2">Initial value: 0.04%</p>
                </div>
            </div>

            <div class="bg-yellow-50 p-5 rounded-xl border-l-4 border-yellow-400 text-sm">
                <h3 class="font-bold text-yellow-800 mb-2 flex items-center gap-2"><i class="fas fa-lightbulb"></i><span data-i18n="teacherNotesTitle">Teacherâ€™s observations:</span></h3>
                <ul class="list-disc list-inside space-y-1 text-yellow-900">
                    <li data-i18n="noteDay">Daytime (06:00â€“18:00): Photosynthesis rate &gt; respiration rate. Plants release oxygen and absorb carbon dioxide, so the blue line rises and the red line falls.</li>
                    <li data-i18n="noteNight">Night (18:00â€“06:00): Photosynthesis stops. Plants and animals only respire, consuming oxygen and releasing carbon dioxide, causing the trends to reverse.</li>
                    <li data-i18n="noteCompensation">Compensation point: The moment when photosynthesis uses exactly as much COâ‚‚ as respiration produces (usually around dawn and dusk).</li>
                </ul>
            </div>
        </div>
    </main>

    <script>
        const translations = {
            "en-US": {
                title: "Micro-Ecosystem Gas Cycle Simulation",
                languageButtonEnglish: "EN",
                languageButtonChinese: "ç¹",
                headerTitle: "Micro-Ecosystem Gas Cycle Simulator",
                headerTag: "Science Experiment Simulation",
                timeLabel: "Time",
                netGasLabel: "Net gas change",
                controlHeading: "Experiment Parameters",
                startButton: "Start",
                resumeButton: "Resume",
                pauseButton: "Pause",
                resetButton: "Reset",
                plantLabel: "Number of plants (producers)",
                animalLabel: "Number of animals (consumers)",
                fewLabel: "Few",
                manyLabel: "Many",
                noneLabel: "None",
                speedLabel: "Simulation speed",
                speedSlow: "Slow (detailed view)",
                speedNormal: "Normal",
                speedFast: "Fast (trend focus)",
                chartHeading: "Gas concentration trends",
                legendO2: "Oxygen (Oâ‚‚)",
                legendCO2: "Carbon dioxide (COâ‚‚)",
                currentO2Label: "Current oxygen concentration",
                currentCO2Label: "Current carbon dioxide concentration",
                initialO2: "Initial value: 21.0%",
                initialCO2: "Initial value: 0.04%",
                teacherNotesTitle: "Teacherâ€™s observations:",
                noteDay: "Daytime (06:00â€“18:00): Photosynthesis rate > respiration rate. Plants release oxygen and absorb carbon dioxide, so the blue line rises and the red line falls.",
                noteNight: "Night (18:00â€“06:00): Photosynthesis stops. Plants and animals only respire, consuming oxygen and releasing carbon dioxide, causing the trends to reverse.",
                noteCompensation: "Compensation point: The moment when photosynthesis uses exactly as much COâ‚‚ as respiration produces (usually around dawn and dusk).",
                statusPhotosynthesis: '<span class="text-blue-600"><i class="fas fa-arrow-up"></i> Oxygen increasing</span> <span class="text-red-600 ml-2"><i class="fas fa-arrow-down"></i> COâ‚‚ decreasing</span>',
                statusCompensation: '<span class="text-gray-600">Photosynthesis is weak (near compensation point)</span>',
                statusNight: '<span class="text-blue-400"><i class="fas fa-arrow-down"></i> Oxygen decreasing</span> <span class="text-red-400 ml-2"><i class="fas fa-arrow-up"></i> COâ‚‚ increasing</span>',
                chartDatasetO2: "Oxygen (Oâ‚‚)",
                chartDatasetCO2: "Carbon dioxide (COâ‚‚)",
                axisTime: "Time (hours)",
                axisO2: "Oxygen concentration (%)",
                axisCO2: "COâ‚‚ concentration (%)",
                tooltipTitle: "Day {day} {time}",
                tooltipLabel: "{label}: {value}%"
            },
            "zh-HK": {
                title: "å¾®ç”Ÿå¢ƒæ°£é«”å¾ªç’°æ¨¡æ“¬å¯¦é©—",
                languageButtonEnglish: "EN",
                languageButtonChinese: "ç¹",
                headerTitle: "å¾®ç”Ÿå¢ƒæ°£é«”å¾ªç’°æ¨¡æ“¬å™¨",
                headerTag: "ç§‘å­¸å¯¦é©—æ¨¡æ“¬",
                timeLabel: "æ™‚é–“",
                netGasLabel: "æ·¨æ°£é«”è®ŠåŒ–",
                controlHeading: "å¯¦é©—åƒæ•¸è¨­å®š",
                startButton: "é–‹å§‹",
                resumeButton: "ç¹¼çºŒ",
                pauseButton: "æš«åœ",
                resetButton: "é‡ç½®",
                plantLabel: "æ¤ç‰©æ•¸é‡ï¼ˆç”Ÿç”¢è€…ï¼‰",
                animalLabel: "å‹•ç‰©æ•¸é‡ï¼ˆæ¶ˆè²»è€…ï¼‰",
                fewLabel: "å°‘",
                manyLabel: "å¤š",
                noneLabel: "ç„¡",
                speedLabel: "æ¨¡æ“¬é€Ÿåº¦",
                speedSlow: "æ…¢é€Ÿï¼ˆä»”ç´°è§€å¯Ÿï¼‰",
                speedNormal: "æ­£å¸¸",
                speedFast: "å¿«é€Ÿï¼ˆè§€å¯Ÿè¶¨å‹¢ï¼‰",
                chartHeading: "æ°£é«”æ¿ƒåº¦è®ŠåŒ–è¶¨å‹¢åœ–",
                legendO2: "æ°§æ°£ (Oâ‚‚)",
                legendCO2: "äºŒæ°§åŒ–ç¢³ (COâ‚‚)",
                currentO2Label: "ç•¶å‰æ°§æ°£æ¿ƒåº¦",
                currentCO2Label: "ç•¶å‰äºŒæ°§åŒ–ç¢³æ¿ƒåº¦",
                initialO2: "åˆå§‹å€¼ï¼š21.0%",
                initialCO2: "åˆå§‹å€¼ï¼š0.04%",
                teacherNotesTitle: "è€å¸«çš„è§€å¯Ÿç­†è¨˜ï¼š",
                noteDay: "ç™½å¤©ï¼ˆ06:00â€“18:00ï¼‰ï¼šå…‰åˆä½œç”¨é€Ÿç‡ > å‘¼å¸ä½œç”¨é€Ÿç‡ã€‚æ¤ç‰©é‡‹æ”¾æ°§æ°£ã€å¸æ”¶äºŒæ°§åŒ–ç¢³ï¼Œå› æ­¤è—ç·šä¸Šå‡ã€ç´…ç·šä¸‹é™ã€‚",
                noteNight: "å¤œæ™šï¼ˆ18:00â€“06:00ï¼‰ï¼šå…‰åˆä½œç”¨åœæ­¢ã€‚æ¤ç‰©èˆ‡å‹•ç‰©åªé€²è¡Œå‘¼å¸ä½œç”¨ï¼Œæ¶ˆè€—æ°§æ°£ä¸¦é‡‹æ”¾äºŒæ°§åŒ–ç¢³ï¼Œè¶¨å‹¢æœƒåè½‰ã€‚",
                noteCompensation: "è£œå„Ÿé»ï¼šå…‰åˆä½œç”¨æ¶ˆè€—çš„ COâ‚‚ èˆ‡å‘¼å¸ä½œç”¨ç”¢ç”Ÿçš„ COâ‚‚ ç›¸ç­‰çš„æ™‚åˆ»ï¼ˆé€šå¸¸åœ¨é»æ˜èˆ‡é»ƒæ˜ï¼‰ã€‚",
                statusPhotosynthesis: '<span class="text-blue-600"><i class="fas fa-arrow-up"></i> æ°§æ°£å¢åŠ </span> <span class="text-red-600 ml-2"><i class="fas fa-arrow-down"></i> COâ‚‚ æ¸›å°‘</span>',
                statusCompensation: '<span class="text-gray-600">å…‰åˆä½œç”¨å¾®å¼±ï¼ˆè£œå„Ÿé»é™„è¿‘ï¼‰</span>',
                statusNight: '<span class="text-blue-400"><i class="fas fa-arrow-down"></i> æ°§æ°£æ¸›å°‘</span> <span class="text-red-400 ml-2"><i class="fas fa-arrow-up"></i> COâ‚‚ å¢åŠ </span>',
                chartDatasetO2: "æ°§æ°£ (Oâ‚‚)",
                chartDatasetCO2: "äºŒæ°§åŒ–ç¢³ (COâ‚‚)",
                axisTime: "æ™‚é–“ï¼ˆå°æ™‚ï¼‰",
                axisO2: "æ°§æ°£æ¿ƒåº¦ (%)",
                axisCO2: "COâ‚‚ æ¿ƒåº¦ (%)",
                tooltipTitle: "ç¬¬ {day} å¤© {time}",
                tooltipLabel: "{label}ï¼š{value}%"
            }
        };

        let currentLang = "en-US";

        function getTranslation(key) {
            const dict = translations[currentLang] || translations["en-US"];
            return dict[key] || "";
        }

        function applyTranslations() {
            document.documentElement.lang = currentLang;
            document.title = getTranslation("title");
            document.querySelectorAll("[data-i18n]").forEach((el) => {
                const key = el.dataset.i18n;
                if (!key) return;
                const value = getTranslation(key);
                if (value) el.textContent = value;
            });
            updateLangButtons();
            updateButtonLabels();
            setStatus(currentStatusKey);
            updateChartLanguage();
        }

        function updateLangButtons() {
            document.querySelectorAll("[data-lang-switch]").forEach((btn) => {
                const isActive = btn.dataset.langSwitch === currentLang;
                btn.classList.toggle("text-teal-900", isActive);
                btn.classList.toggle("shadow-lg", isActive);
                btn.classList.toggle("bg-white", isActive);
                btn.classList.toggle("bg-white/80", !isActive);
            });
        }

        function setLanguage(lang, skipUrlUpdate = false) {
            if (!translations[lang]) lang = "en-US";
            currentLang = lang;
            applyTranslations();
            if (!skipUrlUpdate) {
                const url = new URL(window.location);
                url.searchParams.set("lang", lang);
                window.history.pushState({}, "", url);
            }
        }

        function setupLanguageSwitcher() {
            document.querySelectorAll("[data-lang-switch]").forEach((btn) => {
                btn.addEventListener("click", () => setLanguage(btn.dataset.langSwitch));
            });
        }

        function initLanguage() {
            setupLanguageSwitcher();
            const params = new URLSearchParams(window.location.search);
            const langParam = params.get("lang");
            const initialLang = translations[langParam] ? langParam : "en-US";
            setLanguage(initialLang, true);
        }

        let isRunning = false;
        let timer = null;
        let hour = 6;
        let minute = 0;
        let dayCount = 1;

        let o2 = 21.0; 
        let co2 = 0.04;

        const PHOTOSYNTHESIS_RATE = 0.008;
        const PLANT_RESPIRATION = 0.001;
        const ANIMAL_RESPIRATION = 0.0035;

        let numPlants = 5;
        let numAnimals = 2;
        let simulationSpeed = 100;

        const ctx = document.getElementById('gasChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: getTranslation('chartDatasetO2'),
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    },
                    {
                        label: getTranslation('chartDatasetCO2'),
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: (items) => getTranslation('tooltipTitle').replace('{day}', dayCount).replace('{time}', items[0].label),
                            label: (context) => {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y?.toFixed(4) ?? '0';
                                return getTranslation('tooltipLabel').replace('{label}', label).replace('{value}', value);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: getTranslation('axisTime') },
                        grid: { display: false }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: getTranslation('axisO2') },
                        suggestedMin: 20.8,
                        suggestedMax: 21.2
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: getTranslation('axisCO2') },
                        grid: { drawOnChartArea: false },
                        suggestedMin: 0,
                        suggestedMax: 0.1
                    }
                }
            }
        });

        function updateChartLanguage() {
            chart.data.datasets[0].label = getTranslation('chartDatasetO2');
            chart.data.datasets[1].label = getTranslation('chartDatasetCO2');
            chart.options.scales.x.title.text = getTranslation('axisTime');
            chart.options.scales.y.title.text = getTranslation('axisO2');
            chart.options.scales.y1.title.text = getTranslation('axisCO2');
            chart.update();
        }

        const clockDisplay = document.getElementById('clock-display');
        const container = document.getElementById('ecosystem-container');
        const celestial = document.getElementById('celestial-body');
        const statusText = document.getElementById('status-text');
        const o2Display = document.getElementById('o2-display');
        const co2Display = document.getElementById('co2-display');
        const btnPlay = document.getElementById('btn-play');
        const bubblesLayer = document.getElementById('bubbles-layer');

        let currentStatusKey = 'statusPhotosynthesis';
        let playButtonMode = 'start';

        function initChart() {
            addDataPoint(true);
        }

        function updateSettings() {
            numPlants = parseInt(document.getElementById('plant-slider').value, 10);
            numAnimals = parseInt(document.getElementById('animal-slider').value, 10);
            simulationSpeed = parseInt(document.getElementById('speed-select').value, 10);
            
            document.getElementById('plant-count').innerText = numPlants;
            document.getElementById('animal-count').innerText = numAnimals;

            const plantContainer = document.getElementById('plants-container');
            plantContainer.innerHTML = '';
            for (let i = 0; i < numPlants; i++) {
                plantContainer.innerHTML += Math.random() > 0.5 ? '<i class="fas fa-tree"></i>' : '<i class="fas fa-seedling"></i>';
            }

            const animalContainer = document.getElementById('animals-container');
            animalContainer.innerHTML = '';
            const animalIcons = ['<i class="fas fa-frog"></i>', '<i class="fas fa-crow"></i>', '<i class="fas fa-bug"></i>'];
            for (let i = 0; i < numAnimals; i++) {
                const icon = animalIcons[Math.floor(Math.random() * animalIcons.length)];
                animalContainer.innerHTML += icon;
            }

            if (isRunning) {
                clearInterval(timer);
                timer = setInterval(tick, simulationSpeed);
            }
        }

        function createBubbles(type) {
            if (Math.random() > 0.7) return;
            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.style.left = `${Math.random() * 100}%`;
            const size = Math.random() * 10 + 5;
            bubble.style.width = `${size}px`;
            bubble.style.height = `${size}px`;
            bubble.style.background = type === 'O2' ? 'rgba(59, 130, 246, 0.6)' : 'rgba(239, 68, 68, 0.6)';
            bubblesLayer.appendChild(bubble);
            setTimeout(() => bubble.remove(), 4000);
        }

        function tick() {
            minute += 15;
            if (minute >= 60) {
                minute = 0;
                hour++;
                if (hour >= 24) {
                    hour = 0;
                    dayCount++;
                }
                addDataPoint();
            }

            const isDay = hour >= 6 && hour < 18;

            const totalRespiration = (numPlants * PLANT_RESPIRATION) + (numAnimals * ANIMAL_RESPIRATION);
            let co2LimitingFactor = co2 < 0.01 ? co2 * 100 : 1;
            let currentPhotoRate = 0;
            if (isDay) {
                const dayProgress = (hour - 6 + minute/60) / 12;
                const sunIntensity = Math.sin(dayProgress * Math.PI);
                currentPhotoRate = numPlants * PHOTOSYNTHESIS_RATE * sunIntensity * co2LimitingFactor;
            }

            const o2Change = currentPhotoRate - totalRespiration;
            const co2Change = totalRespiration - currentPhotoRate;
            const DAMPING = 0.05;
            o2 = Math.max(0, Math.min(30, o2 + o2Change * DAMPING));
            co2 = Math.max(0, co2 + co2Change * DAMPING);
            updateVisuals(isDay, currentPhotoRate, totalRespiration);
        }

        function setStatus(key) {
            currentStatusKey = key;
            statusText.innerHTML = getTranslation(key);
        }

        function updateVisuals(isDay, photoRate, respRate) {
            const hStr = hour.toString().padStart(2, '0');
            const mStr = minute.toString().padStart(2, '0');
            clockDisplay.innerText = `${hStr}:${mStr}`;

            if (isDay) {
                container.classList.remove('night-sky');
                container.classList.add('day-sky');
                celestial.innerText = 'â˜€ï¸';
                if (photoRate > respRate) {
                    setStatus('statusPhotosynthesis');
                    createBubbles('O2');
                } else {
                    setStatus('statusCompensation');
                }
            } else {
                container.classList.remove('day-sky');
                container.classList.add('night-sky');
                celestial.innerText = 'ğŸŒ™';
                setStatus('statusNight');
                createBubbles('CO2');
            }

            o2Display.innerText = o2.toFixed(3) + '%';
            co2Display.innerText = co2.toFixed(4) + '%';
        }

        function addDataPoint(isInit = false) {
            const timeLabel = `${hour.toString().padStart(2, '0')}:00`;
            if (chart.data.labels.length > 48) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }
            chart.data.labels.push(timeLabel);
            chart.data.datasets[0].data.push(o2);
            chart.data.datasets[1].data.push(co2);
            chart.update(isInit ? undefined : 'none');
        }

        function updateButtonLabels() {
            const textKey = playButtonMode === 'start' ? 'startButton' : playButtonMode === 'pause' ? 'pauseButton' : 'resumeButton';
            const iconClass = playButtonMode === 'pause' ? 'fa-pause' : 'fa-play';
            btnPlay.innerHTML = `<i class="fas ${iconClass}"></i><span>${getTranslation(textKey)}</span>`;
        }

        function toggleSimulation() {
            if (isRunning) {
                clearInterval(timer);
                playButtonMode = 'resume';
                btnPlay.classList.remove('bg-red-600', 'hover:bg-red-700');
                btnPlay.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                timer = setInterval(tick, simulationSpeed);
                playButtonMode = 'pause';
                btnPlay.classList.remove('bg-green-600', 'hover:bg-green-700');
                btnPlay.classList.add('bg-red-600', 'hover:bg-red-700');
            }
            isRunning = !isRunning;
            updateButtonLabels();
        }

        function resetSimulation() {
            clearInterval(timer);
            isRunning = false;
            hour = 6;
            minute = 0;
            dayCount = 1;
            o2 = 21.0;
            co2 = 0.04;
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.data.datasets[1].data = [];
            playButtonMode = 'start';
            btnPlay.classList.remove('bg-red-600', 'hover:bg-red-700');
            btnPlay.classList.add('bg-green-600', 'hover:bg-green-700');
            updateSettings();
            updateVisuals(true, 0, 0);
            initChart();
            chart.update();
            updateButtonLabels();
        }

        initLanguage();
        updateSettings();
        updateVisuals(true, 0, 0);
        initChart();
    </script>
</body>
</html>
